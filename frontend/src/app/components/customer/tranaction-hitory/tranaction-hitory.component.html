<div class="transaction-history-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-icon">üìä</div>
      <div class="header-text">
        <h1>Transaction History</h1>
        <p>View and manage your car wash bookings</p>
      </div>
    </div>
    <div class="header-stats">
      <div class="stat-item">
        <span class="stat-number">{{ bookings.length }}</span>
        <span class="stat-label">Total Bookings</span>
      </div>
      <button
        class="refresh-btn"
        (click)="loadBookings()"
        [disabled]="isLoading"
      >
        <span class="refresh-icon">üîÑ</span>
        Refresh
      </button>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">
    <div class="filter-tabs">
      <button
        class="filter-tab"
        [class.active]="currentFilter === 'all'"
        (click)="setFilter('all')"
      >
        <span class="tab-icon">üìã</span>
        <span class="tab-text">All</span>
        <span class="tab-count">{{ bookings.length }}</span>
      </button>
      <button
        class="filter-tab"
        [class.active]="currentFilter === 'pending'"
        (click)="setFilter('pending')"
      >
        <span class="tab-icon">‚è≥</span>
        <span class="tab-text">Pending</span>
        <span class="tab-count">{{ getFilterCount("pending") }}</span>
      </button>
      <button
        class="filter-tab"
        [class.active]="currentFilter === 'approved'"
        (click)="setFilter('approved')"
      >
        <span class="tab-icon">‚úÖ</span>
        <span class="tab-text">Approved</span>
        <span class="tab-count">{{ getFilterCount("approved") }}</span>
      </button>
      <button
        class="filter-tab"
        [class.active]="currentFilter === 'completed'"
        (click)="setFilter('completed')"
      >
        <span class="tab-icon">üéâ</span>
        <span class="tab-text">Completed</span>
        <span class="tab-count">{{ getFilterCount("completed") }}</span>
      </button>
      <button
        class="filter-tab"
        [class.active]="currentFilter === 'cancelled'"
        (click)="setFilter('cancelled')"
      >
        <span class="tab-icon">‚ùå</span>
        <span class="tab-text">Cancelled</span>
        <span class="tab-count">{{ getFilterCount("cancelled") }}</span>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">Loading your transactions...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage" class="error-container">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Oops! Something went wrong</h3>
    <p>{{ errorMessage }}</p>
    <button class="retry-btn" (click)="loadBookings()">
      <span class="retry-icon">üîÑ</span>
      Try Again
    </button>
  </div>

  <!-- Success State -->
  <div *ngIf="successMessage" class="success-container">
    <div class="success-icon">‚úÖ</div>
    <h3>Success!</h3>
    <p>{{ successMessage }}</p>
    <p class="success-note">
      Your booking list has been refreshed with the latest data.
    </p>
    <button class="close-btn" (click)="clearSuccessMessage()">
      <span class="close-icon">‚úï</span>
      Close
    </button>
  </div>

  <!-- Empty State -->
  <div
    *ngIf="!isLoading && !errorMessage && bookings.length === 0"
    class="empty-state"
  >
    <div class="empty-icon">üì≠</div>
    <h3>No Transactions Yet</h3>
    <p>
      You haven't made any car wash bookings yet. Book your first service to get
      started!
    </p>
    <button class="book-now-btn">
      <span class="book-icon">üöó</span>
      Book Now
    </button>
  </div>

  <!-- No Filter Results -->
  <div
    *ngIf="
      !isLoading &&
      !errorMessage &&
      bookings.length > 0 &&
      filteredBookings.length === 0
    "
    class="empty-state"
  >
    <div class="empty-icon">üîç</div>
    <h3>No Results Found</h3>
    <p>
      No transactions match the current filter. Try selecting a different
      filter.
    </p>
  </div>

  <!-- Transaction Cards -->
  <div
    *ngIf="!isLoading && !errorMessage && filteredBookings.length > 0"
    class="transactions-grid"
  >
    <div
      class="transaction-card"
      *ngFor="let booking of filteredBookings; trackBy: trackByBooking"
    >
      <div class="card-header">
        <div class="booking-id">
          <span class="id-label">{{ booking.serviceName }}</span>
        </div>
        <div
          class="status-badge"
          [ngClass]="'status-' + normalizeStatus(booking.status)"
        >
          <span class="status-icon">{{
            getStatusIcon(normalizeStatus(booking.status))
          }}</span>
          {{ displayStatus(booking.status) }}
        </div>
      </div>

      <div class="card-body">
        <div class="service-info">
          <div class="service-icon">üöø</div>
          <div class="service-details">
            <h4 class="service-name">{{ booking.serviceName }}</h4>
            <p class="service-description" *ngIf="booking.serviceDescription">
              {{ booking.serviceDescription }}
            </p>
          </div>
        </div>

        <div class="booking-details">
          <div class="detail-row">
            <div class="detail-item">
              <span class="detail-icon">üìÖ</span>
              <span class="detail-label">Date</span>
              <span class="detail-value">{{
                booking.washDate | date : "MMM dd, yyyy"
              }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-icon">‚è∞</span>
              <span class="detail-label">Time</span>
              <span class="detail-value">{{
                formatTime(booking.washTime)
              }}</span>
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-item">
              <span class="detail-icon">üöó</span>
              <span class="detail-label">Vehicle</span>
              <span class="detail-value">{{
                booking.vehicleType || "Car"
              }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-icon">üí≥</span>
              <span class="detail-label">Payment</span>
              <span class="detail-value">{{ booking.paymentType }}</span>
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-item">
              <span class="detail-icon">üë§</span>
              <span class="detail-label">Assigned To</span>
              <span
                class="detail-value"
                [ngClass]="{
                  'pending-assignment': !hasEmployeeAssigned(booking),
                  'assigned-employee': hasEmployeeAssigned(booking)
                }"
              >
                {{ getEmployeeInfo(booking) }}
              </span>
            </div>
          </div>
        </div>

        <div class="price-section">
          <div class="price-amount">
            <span class="currency">‚Ç±</span>
            <span class="amount">{{ booking.price }}</span>
          </div>
          <span class="price-label">Total Amount</span>
        </div>
      </div>

      <div class="card-actions">
        <button class="action-btn view-btn" (click)="openViewModal(booking)">
          <span class="btn-icon">üëÅÔ∏è</span>
          View Details
        </button>
        <button
          *ngIf="canCancelBooking(booking)"
          class="action-btn cancel-btn"
          (click)="openCancelModal(booking)"
        >
          <span class="btn-icon">‚ùå</span>
          Cancel Booking
        </button>
        <button class="action-btn feedback-btn" (click)="openFeedbackModal()">
          <span class="btn-icon">üí¨</span>
          Feedback
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced View Transaction Modal -->
<div
  class="modal-overlay"
  [class.show]="isViewModalOpen"
  (click)="closeViewModal()"
>
  <div
    class="modal-container"
    (click)="$event.stopPropagation()"
    *ngIf="selectedBooking"
  >
    <div class="modal-header">
      <div class="modal-title">
        <h2>Transaction Details</h2>
        <span class="transaction-id">{{ selectedBooking.serviceName }}</span>
      </div>
      <button class="close-btn" (click)="closeViewModal()">
        <span class="close-icon">‚úï</span>
      </button>
    </div>

    <div class="modal-body">
      <div
        class="status-banner"
        [ngClass]="'status-' + normalizeStatus(selectedBooking.status)"
      >
        <div class="status-content">
          <span class="status-icon-large">{{
            getStatusIcon(normalizeStatus(selectedBooking.status))
          }}</span>
          <div class="status-info">
            <h3>{{ displayStatus(selectedBooking.status) }}</h3>
            <p>
              {{
                getStatusDescription(normalizeStatus(selectedBooking.status))
              }}
            </p>
          </div>
        </div>
      </div>

      <div class="details-grid">
        <div class="detail-card">
          <div class="detail-header">
            <span class="detail-icon">üìÖ</span>
            <h4>Booking Information</h4>
          </div>
          <div class="detail-content">
            <div class="detail-row">
              <span class="label">Date:</span>
              <span class="value">{{
                selectedBooking.washDate | date : "EEEE, MMMM dd, yyyy"
              }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Time:</span>
              <span class="value">{{
                formatTime(selectedBooking.washTime)
              }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Vehicle Type:</span>
              <span class="value">{{
                selectedBooking.vehicleType || "Car"
              }}</span>
            </div>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-header">
            <span class="detail-icon">üöø</span>
            <h4>Service Details</h4>
          </div>
          <div class="detail-content">
            <div class="detail-row">
              <span class="label">Service:</span>
              <span class="value">{{ selectedBooking.serviceName }}</span>
            </div>
            <div class="detail-row" *ngIf="selectedBooking.serviceDescription">
              <span class="label">Description:</span>
              <span class="value">{{
                selectedBooking.serviceDescription
              }}</span>
            </div>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-header">
            <span class="detail-icon">üë§</span>
            <h4>Employee Assignment</h4>
          </div>
          <div class="detail-content">
            <div class="detail-row">
              <span class="label">Assigned To:</span>
              <span
                class="value"
                [ngClass]="{
                  'pending-assignment': !hasEmployeeAssigned(selectedBooking),
                  'assigned-employee': hasEmployeeAssigned(selectedBooking)
                }"
              >
                {{ getEmployeeInfo(selectedBooking) }}
              </span>
            </div>
            <div
              class="detail-row"
              *ngIf="hasEmployeeAssigned(selectedBooking)"
            >
              <span class="label">Employee ID:</span>
              <span class="value">{{
                selectedBooking.assignedEmployeeId
              }}</span>
            </div>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-header">
            <span class="detail-icon">üí≥</span>
            <h4>Payment Information</h4>
          </div>
          <div class="detail-content">
            <div class="detail-row">
              <span class="label">Amount:</span>
              <span class="value price">{{
                selectedBooking.price | currency : "PHP"
              }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Method:</span>
              <span class="value">{{ selectedBooking.paymentType }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="modal-btn secondary" (click)="closeViewModal()">
        Close
      </button>
      <button class="modal-btn primary" (click)="openFeedbackModal()">
        <span class="btn-icon">üí¨</span>
        Leave Feedback
      </button>
    </div>
  </div>
</div>

<!-- Enhanced Feedback Modal -->
<div
  class="modal-overlay"
  [class.show]="isFeedbackModalOpen"
  (click)="closeFeedbackModal()"
>
  <div
    class="modal-container feedback-modal"
    (click)="$event.stopPropagation()"
  >
    <div class="modal-header">
      <div class="modal-title">
        <h2>Share Your Experience</h2>
        <p>We'd love to hear about your car wash service</p>
      </div>
      <button class="close-btn" (click)="closeFeedbackModal()">
        <span class="close-icon">‚úï</span>
      </button>
    </div>

    <div class="modal-body">
      <div class="rating-section">
        <h3>How would you rate our service?</h3>
        <div class="star-rating">
          <button
            class="star-btn"
            *ngFor="let star of [1, 2, 3, 4, 5]"
            [class.active]="star <= currentRating"
            (click)="setRating(star)"
          >
            <span class="star-icon">‚òÖ</span>
          </button>
        </div>
        <p class="rating-text">{{ getRatingText() }}</p>
      </div>

      <div class="feedback-section">
        <label for="feedback-text">Tell us more about your experience:</label>
        <textarea
          id="feedback-text"
          placeholder="Share your thoughts, suggestions, or any issues you encountered..."
          rows="4"
          class="feedback-textarea"
        ></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="modal-btn secondary" (click)="closeFeedbackModal()">
        Cancel
      </button>
      <button
        class="modal-btn primary submit-btn"
        [disabled]="currentRating === 0"
      >
        <span class="btn-icon">üì§</span>
        Submit Feedback
      </button>
    </div>
  </div>
</div>

<!-- Cancel Booking Confirmation Modal -->
<div
  class="modal-overlay"
  [class.show]="isCancelModalOpen"
  (click)="closeCancelModal()"
>
  <div
    class="modal-container cancel-modal"
    (click)="$event.stopPropagation()"
    *ngIf="bookingToCancel"
  >
    <div class="modal-header">
      <div class="modal-title">
        <h2>Cancel Booking</h2>
        <p>Are you sure you want to cancel this booking?</p>
      </div>
      <button class="close-btn" (click)="closeCancelModal()">
        <span class="close-icon">‚úï</span>
      </button>
    </div>

    <div class="modal-body">
      <div class="cancel-warning">
        <div class="warning-icon">‚ö†Ô∏è</div>
        <h3>This action cannot be undone</h3>
        <p>
          Once cancelled, this booking will be permanently removed from your
          transaction history.
        </p>
      </div>

      <div class="booking-summary">
        <h4>Booking Details:</h4>
        <div class="summary-item">
          <span class="label">Service:</span>
          <span class="value">{{ bookingToCancel.serviceName }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Date:</span>
          <span class="value">{{
            bookingToCancel.washDate | date : "MMM dd, yyyy"
          }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Time:</span>
          <span class="value">{{ formatTime(bookingToCancel.washTime) }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Amount:</span>
          <span class="value">‚Ç± {{ bookingToCancel.price }}</span>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button
        class="modal-btn secondary"
        (click)="closeCancelModal()"
        [disabled]="isCancelling"
      >
        Keep Booking
      </button>
      <button
        class="modal-btn danger"
        (click)="cancelBooking()"
        [disabled]="isCancelling"
      >
        <span class="btn-icon" *ngIf="!isCancelling">‚ùå</span>
        <span class="btn-icon" *ngIf="isCancelling">‚è≥</span>
        {{ isCancelling ? "Cancelling..." : "Cancel Booking" }}
      </button>
    </div>
  </div>
</div>
